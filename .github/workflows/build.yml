name: Build Wheel using Hatch

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-wheel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install "virtualenv==20.23.1"
          python -m pip install --upgrade hatch

      - name: Build wheel with hatch
        run: hatch build
      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel
          path: dist/*.whl

              - uses: actions/checkout@v4

              - name: Build Docker image (hatch stage)
                uses: docker/build-push-action@v4
                with:
                  context: .
                  file: ./Dockerfile
                  target: hatch
                  tags: shell-ci:latest

              - name: Run build inside Docker container
                run: |
                  docker run --rm \
                    -v "${{ github.workspace }}:/app" \
                    -w /app \
                    shell-ci:latest build

              - name: Upload wheel
                uses: actions/upload-artifact@v4
                with:
                  name: wheel
                  path: dist/*.whl
